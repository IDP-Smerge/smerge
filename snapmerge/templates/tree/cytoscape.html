<script>
    var cy = window.cy = cytoscape({
  container: document.getElementById('cy'),
    minZoom: 0.5,
    maxZoom: 24,
  autounselectify: false,
    selectionType: 'additive',
  layout: {
    name: 'dagre'
  },

  style: [
    {
      selector: 'node',
      style: {
        'content': 'data(id)',
        'text-opacity': 0.5,
        'text-valign': 'center',
        'text-halign': 'right',
        'background-color': '#11479e'
      }
    },

    {
      selector: 'edge',
      style: {
        'curve-style': 'bezier',
        'width': 4,
        'target-arrow-shape': 'triangle',
        'line-color': '#9dbaea',
        'target-arrow-color': '#9dbaea'
      }
    },
    {
      selector: ':selected',
      style: {
        'background-color': '#CC0000',
      }
    }
  ],


// #open: lokale links funktionieren wohl nicht
  elements: {
    nodes: [
    {% for ele in files  %}
    { data: { id: '{{ele.id}}' , href: '{{ele.file_url}}', description: '{{ele.description}}' } },
    {% endfor %}
    ],
    edges: [
    {% for ele in files  %}
        {% for anc in ele.ancestors  %}
        { data: { source: '{{anc}}', target: '{{ele.id}}' } },
        {% endfor %}
    {% endfor %}
    ]
  },
});


var tappedBefore;
var tappedTimeout;
cy.on('tap', 'node', function(event) {
  var tappedNow = event.cyTarget;
  if (tappedTimeout && tappedBefore) {
    clearTimeout(tappedTimeout);
  }
  if(tappedBefore === tappedNow) {
    this.trigger('dblclick', event.target);
    tappedBefore = null;
  } else {
    tappedTimeout = setTimeout(function(){ tappedBefore = null; }, 300);
    tappedBefore = tappedNow;
  }
});


var open = function(){
    if (this.data('href')){
       $.get(this.data('href')).done(
            function(file){
                       var url = 'http://snap.berkeley.edu/snapsource/snap.html#open:data:text/xml,'+
                           encodeURIComponent( new XMLSerializer().serializeToString(file.documentElement));
                            console.log(url);
                try { // your browser may block popups
                    window.open(url,'_blank');
                } catch(e){ // fall back on url change
                    window.location.href = url;
                }
            }
       );
    }
}

cy.on('dblclick', 'node', open);
cy.on('taphold', 'node', open);


//Tooltip
cy.nodes().each(function(ele){
    ele.qtip({
  content: 'Hello I am ' + ele.data('id'),
  position: {
    my: 'top center',
    at: 'bottom center'
  },
  style: {
    classes: 'qtip-bootstrap',
    tip: {
      width: 16,
      height: 8
    }
  }
});
});
//TODO:
/*
// qTip2 call below will grab this JSON and use the firstName as the content
$('.selector').qtip({
    content: {
        text: function(event, api) {
            $.ajax({
                url: '/path/to/json/output', // URL to the JSON file
                type: 'GET', // POST or GET
                dataType: 'json', // Tell it we're retrieving JSON
                data: {
                    id: $(this).attr('id') // Pass through the ID of the current element matched by '.selector'
                },
            })
            .then(function(data) {
                //Process the retrieved JSON object Retrieve a specific attribute from our parsed JSON string and set the tooltip content.
                var content = 'My name is ' + data.person.firstName;

                // Now we set the content manually (required!)
                api.set('content.text', content);
            }, function(xhr, status, error) {
                // Upon failure... set the tooltip content to the status and error value
                api.set('content.text', status + ': ' + error);
            });

            return 'Loading...', // Set some initial loading text
        }
    }
});
*/


var findOptimalPosition = function(elements){
    var xPositions = [];
    var yPositions = [];
    elements.each(function(ele){
       xPositions.push(ele.position('x'));
       yPositions.push(ele.position('y'));
    });
    return [Math.min(...xPositions)+(Math.max(...xPositions)-Math.min(...xPositions))/2, Math.max(...yPositions)+75];
}

var getNextId = function(){
    // Abfrage am Server, der neue Node eintrÃ¤gt.
    //Vorerst machen wir was zufaelliges
    return 100+ Math.floor(Math.random()*5000);
}


$('#merge').mousedown(function (evt) {
  //  if (cy.selectionType = 'single'){
     //   cy.selectionType = 'additive';
        var selectedElements = cy.$(':selected')

        if (selectedElements.length > 0){
            console.log(selectedElements);

            var merge_url = 'merge/{{proj_id}}';
            var first = true;
            selectedElements.forEach(function(ele){
                if (first){
                    merge_url += '?';
                    first = false;
                }
                else {
                    merge_url += '&';
                }
                merge_url += 'file='+ele.data('id');
            });

            var merged_node;
            $.ajax({
                url: merge_url,
                cache: false
            })
            .done(function(new_node) {

                var positions = findOptimalPosition(selectedElements);

                var eleNeu = cy.add({
                    group: "nodes",
                    data: { id: new_node.id, href: new_node.file_url },
                    position: { x: positions[0], y: positions[1] }
                });

                selectedElements.forEach(function(ele){
                   cy.add ({
                        group: "edges",
                        data: { source: ele.data('id'), target: new_node.id }
                    });
                });

            cy.$(':selected').unselect();

            });
        }

 //   }

});

</script>
